"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const axios_1 = __importDefault(require("axios"));
const api_1 = require("./api");
jest.mock('axios');
const axiosMock = axios_1.default;
describe('Rate Limit Adapter', () => {
    let onRateLimitExceededStub;
    let onRateLimitPauseStub;
    let onRateLimitResumeStub;
    beforeAll(() => {
        onRateLimitExceededStub = jest.fn();
        onRateLimitPauseStub = jest.fn();
        onRateLimitResumeStub = jest.fn();
    });
    beforeEach(() => {
        onRateLimitExceededStub.mockReset();
        onRateLimitPauseStub.mockReset();
        onRateLimitResumeStub.mockReset();
    });
    it('should handle RateLimitExceededError', () => {
        axiosMock
            .mockResolvedValueOnce({
            status: 405,
            headers: {
                'retry-after': '1',
                'x-ratelimit-read': '1000',
                'x-ratelimit-system': '1000-Default',
                'x-ratelimit-write': '1000',
            },
            body: {},
        })
            .mockResolvedValueOnce({
            status: 200,
            headers: {},
            body: {},
        });
        const api = new api_1.AnxApi({
            target: 'http://api.example.com',
            rateLimiting: true,
            onRateLimitExceeded: onRateLimitExceededStub,
            onRateLimitPause: onRateLimitPauseStub,
            onRateLimitResume: onRateLimitResumeStub,
        });
        expect.assertions(3);
        return api.get('/limit').then(() => {
            expect(onRateLimitExceededStub).toHaveBeenCalledTimes(1);
            expect(onRateLimitPauseStub).toHaveBeenCalledTimes(1);
            expect(onRateLimitResumeStub).toHaveBeenCalledTimes(1);
            return null;
        });
    });
    it('should handle non-standard RateLimitExceededError', () => {
        axiosMock.mockResolvedValueOnce({
            status: 405,
            headers: {
                'x-ratelimit-read': '1000',
                'x-ratelimit-system': '1000-Default',
                'x-ratelimit-write': '1000',
            },
            body: {},
        });
        const api = new api_1.AnxApi({
            target: 'http://api.example.com',
            rateLimiting: true,
            onRateLimitExceeded: onRateLimitExceededStub,
            onRateLimitPause: onRateLimitPauseStub,
            onRateLimitResume: onRateLimitResumeStub,
        });
        expect.assertions(3);
        return api.get('/limit-bad').catch(() => {
            expect(onRateLimitExceededStub).toHaveBeenCalledTimes(1);
            expect(onRateLimitPauseStub).not.toHaveBeenCalled();
            expect(onRateLimitResumeStub).not.toHaveBeenCalled();
        });
    });
    it('should adapt up limits', () => {
        axiosMock
            .mockResolvedValueOnce({
            status: 200,
            headers: {
                'x-ratelimit-read': '6',
                'x-ratelimit-system': '1000-Default',
                'x-ratelimit-write': '1000',
            },
            body: {},
        })
            .mockResolvedValueOnce({
            status: 200,
            headers: {},
            body: {},
        });
        const api = new api_1.AnxApi({
            target: 'http://api.example.com',
            rateLimiting: true,
            rateLimitReadSeconds: 1,
            onRateLimitExceeded: onRateLimitExceededStub,
            onRateLimitPause: onRateLimitPauseStub,
            onRateLimitResume: onRateLimitResumeStub,
        });
        expect.assertions(3);
        return api.get('/limit').then(() => {
            return api.get('/limit').then(() => {
                expect(onRateLimitExceededStub).not.toHaveBeenCalled();
                expect(onRateLimitPauseStub).not.toHaveBeenCalled();
                expect(onRateLimitResumeStub).not.toHaveBeenCalled();
                return null;
            });
        });
    });
    it('should adapt down limits', () => {
        axiosMock
            .mockResolvedValueOnce({
            status: 200,
            headers: {
                'x-ratelimit-read': '1',
                'x-ratelimit-system': '1000-Default',
                'x-ratelimit-write': '1000',
            },
            body: {},
        })
            .mockResolvedValueOnce({
            status: 200,
            headers: {},
            body: {},
        });
        const api = new api_1.AnxApi({
            target: 'http://api.example.com',
            rateLimiting: true,
            rateLimitReadSeconds: 2,
            onRateLimitExceeded: onRateLimitExceededStub,
            onRateLimitPause: onRateLimitPauseStub,
            onRateLimitResume: onRateLimitResumeStub,
        });
        expect.assertions(3);
        return api.get('/limit').then(() => {
            return api.get('/limit').then(() => {
                expect(onRateLimitExceededStub).not.toHaveBeenCalled();
                expect(onRateLimitPauseStub).toHaveBeenCalledTimes(1);
                expect(onRateLimitResumeStub).toHaveBeenCalledTimes(1);
                return null;
            });
        });
    });
    it('should limit multiple requests', () => {
        axiosMock
            .mockResolvedValueOnce({
            status: 200,
            headers: {},
            body: {},
        })
            .mockResolvedValueOnce({
            status: 200,
            headers: {},
            body: {},
        })
            .mockResolvedValueOnce({
            status: 200,
            headers: {},
            body: {},
        });
        const api = new api_1.AnxApi({
            target: 'http://api.example.com',
            rateLimiting: true,
            rateLimitRead: 1,
            rateLimitReadSeconds: 1,
            onRateLimitExceeded: onRateLimitExceededStub,
            onRateLimitPause: onRateLimitPauseStub,
            onRateLimitResume: onRateLimitResumeStub,
        });
        expect.assertions(3);
        return Promise.all([api.get('/limit'), api.get('/limit'), api.get('/limit')]).then(() => {
            expect(onRateLimitExceededStub).not.toHaveBeenCalled();
            expect(onRateLimitPauseStub).toHaveBeenCalledTimes(2);
            expect(onRateLimitResumeStub).toHaveBeenCalledTimes(2);
            return;
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmF0ZUxpbWl0QWRhcHRlci5zcGVjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3JhdGVMaW1pdEFkYXB0ZXIuc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGtEQUEwQjtBQUMxQiwrQkFBK0I7QUFFL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNuQixNQUFNLFNBQVMsR0FBYyxlQUFZLENBQUM7QUFFMUMsUUFBUSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRTtJQUNuQyxJQUFJLHVCQUF1QixDQUFDO0lBQzVCLElBQUksb0JBQW9CLENBQUM7SUFDekIsSUFBSSxxQkFBcUIsQ0FBQztJQUUxQixTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2QsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3BDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNqQyxxQkFBcUIsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDbkMsQ0FBQyxDQUFDLENBQUM7SUFFSCxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2YsdUJBQXVCLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDcEMsb0JBQW9CLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDakMscUJBQXFCLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDbkMsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFO1FBQy9DLFNBQVM7YUFDUCxxQkFBcUIsQ0FBQztZQUN0QixNQUFNLEVBQUUsR0FBRztZQUNYLE9BQU8sRUFBRTtnQkFDUixhQUFhLEVBQUUsR0FBRztnQkFDbEIsa0JBQWtCLEVBQUUsTUFBTTtnQkFDMUIsb0JBQW9CLEVBQUUsY0FBYztnQkFDcEMsbUJBQW1CLEVBQUUsTUFBTTthQUMzQjtZQUNELElBQUksRUFBRSxFQUFFO1NBQ1IsQ0FBQzthQUNELHFCQUFx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QixFQUFFLENBQUM7WUFDdkIsbUJBQW1CLEVBQUUsdUJBQXVCO1lBQzVDLGdCQUFnQixFQUFFLG9CQUFvQjtZQUN0QyxpQkFBaUIsRUFBRSxxQkFBcUI7U0FDakMsQ0FBQyxDQUFDO1FBRVYsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVyQixPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUN2RixNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUN2RCxNQUFNLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0RCxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2RCxPQUFPO1FBQ1IsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNKLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcbmltcG9ydCB7IEFueEFwaSB9IGZyb20gJy4vYXBpJztcblxuamVzdC5tb2NrKCdheGlvcycpO1xuY29uc3QgYXhpb3NNb2NrOiBqZXN0Lk1vY2sgPSBheGlvcyBhcyBhbnk7XG5cbmRlc2NyaWJlKCdSYXRlIExpbWl0IEFkYXB0ZXInLCAoKSA9PiB7XG5cdGxldCBvblJhdGVMaW1pdEV4Y2VlZGVkU3R1Yjtcblx0bGV0IG9uUmF0ZUxpbWl0UGF1c2VTdHViO1xuXHRsZXQgb25SYXRlTGltaXRSZXN1bWVTdHViO1xuXG5cdGJlZm9yZUFsbCgoKSA9PiB7XG5cdFx0b25SYXRlTGltaXRFeGNlZWRlZFN0dWIgPSBqZXN0LmZuKCk7XG5cdFx0b25SYXRlTGltaXRQYXVzZVN0dWIgPSBqZXN0LmZuKCk7XG5cdFx0b25SYXRlTGltaXRSZXN1bWVTdHViID0gamVzdC5mbigpO1xuXHR9KTtcblxuXHRiZWZvcmVFYWNoKCgpID0+IHtcblx0XHRvblJhdGVMaW1pdEV4Y2VlZGVkU3R1Yi5tb2NrUmVzZXQoKTtcblx0XHRvblJhdGVMaW1pdFBhdXNlU3R1Yi5tb2NrUmVzZXQoKTtcblx0XHRvblJhdGVMaW1pdFJlc3VtZVN0dWIubW9ja1Jlc2V0KCk7XG5cdH0pO1xuXG5cdGl0KCdzaG91bGQgaGFuZGxlIFJhdGVMaW1pdEV4Y2VlZGVkRXJyb3InLCAoKSA9PiB7XG5cdFx0YXhpb3NNb2NrXG5cdFx0XHQubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcblx0XHRcdFx0c3RhdHVzOiA0MDUsXG5cdFx0XHRcdGhlYWRlcnM6IHtcblx0XHRcdFx0XHQncmV0cnktYWZ0ZXInOiAnMScsXG5cdFx0XHRcdFx0J3gtcmF0ZWxpbWl0LXJlYWQnOiAnMTAwMCcsXG5cdFx0XHRcdFx0J3gtcmF0ZWxpbWl0LXN5c3RlbSc6ICcxMDAwLURlZmF1bHQnLFxuXHRcdFx0XHRcdCd4LXJhdGVsaW1pdC13cml0ZSc6ICcxMDAwJyxcblx0XHRcdFx0fSxcblx0XHRcdFx0Ym9keToge30sXG5cdFx0XHR9KVxuXHRcdFx0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG5cdFx0XHRcdHN0YXR1czogMjAwLFxuXHRcdFx0XHRoZWFkZXJzOiB7fSxcblx0XHRcdFx0Ym9keToge30sXG5cdFx0XHR9KTtcblxuXHRcdGNvbnN0IGFwaSA9IG5ldyBBbnhBcGkoe1xuXHRcdFx0dGFyZ2V0OiAnaHR0cDovL2FwaS5leGFtcGxlLmNvbScsXG5cdFx0XHRyYXRlTGltaXRpbmc6IHRydWUsXG5cdFx0XHRvblJhdGVMaW1pdEV4Y2VlZGVkOiBvblJhdGVMaW1pdEV4Y2VlZGVkU3R1Yixcblx0XHRcdG9uUmF0ZUxpbWl0UGF1c2U6IG9uUmF0ZUxpbWl0UGF1c2VTdHViLFxuXHRcdFx0b25SYXRlTGltaXRSZXN1bWU6IG9uUmF0ZUxpbWl0UmVzdW1lU3R1Yixcblx0XHR9IGFzIGFueSk7XG5cblx0XHRleHBlY3QuYXNzZXJ0aW9ucygzKTtcblxuXHRcdHJldHVybiBhcGkuZ2V0KCcvbGltaXQnKS50aGVuKCgpID0+IHtcblx0XHRcdGV4cGVjdChvblJhdGVMaW1pdEV4Y2VlZGVkU3R1YikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuXHRcdFx0ZXhwZWN0KG9uUmF0ZUxpbWl0UGF1c2VTdHViKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG5cdFx0XHRleHBlY3Qob25SYXRlTGltaXRSZXN1bWVTdHViKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9KTtcblx0fSk7XG5cblx0aXQoJ3Nob3VsZCBoYW5kbGUgbm9uLXN0YW5kYXJkIFJhdGVMaW1pdEV4Y2VlZGVkRXJyb3InLCAoKSA9PiB7XG5cdFx0YXhpb3NNb2NrLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG5cdFx0XHRzdGF0dXM6IDQwNSxcblx0XHRcdGhlYWRlcnM6IHtcblx0XHRcdFx0J3gtcmF0ZWxpbWl0LXJlYWQnOiAnMTAwMCcsXG5cdFx0XHRcdCd4LXJhdGVsaW1pdC1zeXN0ZW0nOiAnMTAwMC1EZWZhdWx0Jyxcblx0XHRcdFx0J3gtcmF0ZWxpbWl0LXdyaXRlJzogJzEwMDAnLFxuXHRcdFx0fSxcblx0XHRcdGJvZHk6IHt9LFxuXHRcdH0pO1xuXG5cdFx0Y29uc3QgYXBpID0gbmV3IEFueEFwaSh7XG5cdFx0XHR0YXJnZXQ6ICdodHRwOi8vYXBpLmV4YW1wbGUuY29tJyxcblx0XHRcdHJhdGVMaW1pdGluZzogdHJ1ZSxcblx0XHRcdG9uUmF0ZUxpbWl0RXhjZWVkZWQ6IG9uUmF0ZUxpbWl0RXhjZWVkZWRTdHViLFxuXHRcdFx0b25SYXRlTGltaXRQYXVzZTogb25SYXRlTGltaXRQYXVzZVN0dWIsXG5cdFx0XHRvblJhdGVMaW1pdFJlc3VtZTogb25SYXRlTGltaXRSZXN1bWVTdHViLFxuXHRcdH0gYXMgYW55KTtcblxuXHRcdGV4cGVjdC5hc3NlcnRpb25zKDMpO1xuXG5cdFx0cmV0dXJuIGFwaS5nZXQoJy9saW1pdC1iYWQnKS5jYXRjaCgoKSA9PiB7XG5cdFx0XHRleHBlY3Qob25SYXRlTGltaXRFeGNlZWRlZFN0dWIpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcblx0XHRcdGV4cGVjdChvblJhdGVMaW1pdFBhdXNlU3R1Yikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcblx0XHRcdGV4cGVjdChvblJhdGVMaW1pdFJlc3VtZVN0dWIpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cdFx0fSk7XG5cdH0pO1xuXG5cdGl0KCdzaG91bGQgYWRhcHQgdXAgbGltaXRzJywgKCkgPT4ge1xuXHRcdGF4aW9zTW9ja1xuXHRcdFx0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG5cdFx0XHRcdHN0YXR1czogMjAwLFxuXHRcdFx0XHRoZWFkZXJzOiB7XG5cdFx0XHRcdFx0J3gtcmF0ZWxpbWl0LXJlYWQnOiAnNicsXG5cdFx0XHRcdFx0J3gtcmF0ZWxpbWl0LXN5c3RlbSc6ICcxMDAwLURlZmF1bHQnLFxuXHRcdFx0XHRcdCd4LXJhdGVsaW1pdC13cml0ZSc6ICcxMDAwJyxcblx0XHRcdFx0fSxcblx0XHRcdFx0Ym9keToge30sXG5cdFx0XHR9KVxuXHRcdFx0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG5cdFx0XHRcdHN0YXR1czogMjAwLFxuXHRcdFx0XHRoZWFkZXJzOiB7fSxcblx0XHRcdFx0Ym9keToge30sXG5cdFx0XHR9KTtcblxuXHRcdGNvbnN0IGFwaSA9IG5ldyBBbnhBcGkoe1xuXHRcdFx0dGFyZ2V0OiAnaHR0cDovL2FwaS5leGFtcGxlLmNvbScsXG5cdFx0XHRyYXRlTGltaXRpbmc6IHRydWUsXG5cdFx0XHRyYXRlTGltaXRSZWFkU2Vjb25kczogMSxcblx0XHRcdG9uUmF0ZUxpbWl0RXhjZWVkZWQ6IG9uUmF0ZUxpbWl0RXhjZWVkZWRTdHViLFxuXHRcdFx0b25SYXRlTGltaXRQYXVzZTogb25SYXRlTGltaXRQYXVzZVN0dWIsXG5cdFx0XHRvblJhdGVMaW1pdFJlc3VtZTogb25SYXRlTGltaXRSZXN1bWVTdHViLFxuXHRcdH0gYXMgYW55KTtcblxuXHRcdGV4cGVjdC5hc3NlcnRpb25zKDMpO1xuXG5cdFx0cmV0dXJuIGFwaS5nZXQoJy9saW1pdCcpLnRoZW4oKCkgPT4ge1xuXHRcdFx0cmV0dXJuIGFwaS5nZXQoJy9saW1pdCcpLnRoZW4oKCkgPT4ge1xuXHRcdFx0XHRleHBlY3Qob25SYXRlTGltaXRFeGNlZWRlZFN0dWIpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cdFx0XHRcdGV4cGVjdChvblJhdGVMaW1pdFBhdXNlU3R1Yikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcblx0XHRcdFx0ZXhwZWN0KG9uUmF0ZUxpbWl0UmVzdW1lU3R1Yikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcblx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHR9KTtcblx0XHR9KTtcblx0fSk7XG5cblx0aXQoJ3Nob3VsZCBhZGFwdCBkb3duIGxpbWl0cycsICgpID0+IHtcblx0XHRheGlvc01vY2tcblx0XHRcdC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuXHRcdFx0XHRzdGF0dXM6IDIwMCxcblx0XHRcdFx0aGVhZGVyczoge1xuXHRcdFx0XHRcdCd4LXJhdGVsaW1pdC1yZWFkJzogJzEnLFxuXHRcdFx0XHRcdCd4LXJhdGVsaW1pdC1zeXN0ZW0nOiAnMTAwMC1EZWZhdWx0Jyxcblx0XHRcdFx0XHQneC1yYXRlbGltaXQtd3JpdGUnOiAnMTAwMCcsXG5cdFx0XHRcdH0sXG5cdFx0XHRcdGJvZHk6IHt9LFxuXHRcdFx0fSlcblx0XHRcdC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuXHRcdFx0XHRzdGF0dXM6IDIwMCxcblx0XHRcdFx0aGVhZGVyczoge30sXG5cdFx0XHRcdGJvZHk6IHt9LFxuXHRcdFx0fSk7XG5cblx0XHRjb25zdCBhcGkgPSBuZXcgQW54QXBpKHtcblx0XHRcdHRhcmdldDogJ2h0dHA6Ly9hcGkuZXhhbXBsZS5jb20nLFxuXHRcdFx0cmF0ZUxpbWl0aW5nOiB0cnVlLFxuXHRcdFx0cmF0ZUxpbWl0UmVhZFNlY29uZHM6IDIsXG5cdFx0XHRvblJhdGVMaW1pdEV4Y2VlZGVkOiBvblJhdGVMaW1pdEV4Y2VlZGVkU3R1Yixcblx0XHRcdG9uUmF0ZUxpbWl0UGF1c2U6IG9uUmF0ZUxpbWl0UGF1c2VTdHViLFxuXHRcdFx0b25SYXRlTGltaXRSZXN1bWU6IG9uUmF0ZUxpbWl0UmVzdW1lU3R1Yixcblx0XHR9IGFzIGFueSk7XG5cblx0XHRleHBlY3QuYXNzZXJ0aW9ucygzKTtcblxuXHRcdHJldHVybiBhcGkuZ2V0KCcvbGltaXQnKS50aGVuKCgpID0+IHtcblx0XHRcdHJldHVybiBhcGkuZ2V0KCcvbGltaXQnKS50aGVuKCgpID0+IHtcblx0XHRcdFx0ZXhwZWN0KG9uUmF0ZUxpbWl0RXhjZWVkZWRTdHViKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuXHRcdFx0XHRleHBlY3Qob25SYXRlTGltaXRQYXVzZVN0dWIpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcblx0XHRcdFx0ZXhwZWN0KG9uUmF0ZUxpbWl0UmVzdW1lU3R1YikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuXHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdH0pO1xuXHRcdH0pO1xuXHR9KTtcblxuXHRpdCgnc2hvdWxkIGxpbWl0IG11bHRpcGxlIHJlcXVlc3RzJywgKCkgPT4ge1xuXHRcdGF4aW9zTW9ja1xuXHRcdFx0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG5cdFx0XHRcdHN0YXR1czogMjAwLFxuXHRcdFx0XHRoZWFkZXJzOiB7fSxcblx0XHRcdFx0Ym9keToge30sXG5cdFx0XHR9KVxuXHRcdFx0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG5cdFx0XHRcdHN0YXR1czogMjAwLFxuXHRcdFx0XHRoZWFkZXJzOiB7fSxcblx0XHRcdFx0Ym9keToge30sXG5cdFx0XHR9KVxuXHRcdFx0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG5cdFx0XHRcdHN0YXR1czogMjAwLFxuXHRcdFx0XHRoZWFkZXJzOiB7fSxcblx0XHRcdFx0Ym9keToge30sXG5cdFx0XHR9KTtcblxuXHRcdGNvbnN0IGFwaSA9IG5ldyBBbnhBcGkoe1xuXHRcdFx0dGFyZ2V0OiAnaHR0cDovL2FwaS5leGFtcGxlLmNvbScsXG5cdFx0XHRyYXRlTGltaXRpbmc6IHRydWUsXG5cdFx0XHRyYXRlTGltaXRSZWFkOiAxLFxuXHRcdFx0cmF0ZUxpbWl0UmVhZFNlY29uZHM6IDEsXG5cdFx0XHRvblJhdGVMaW1pdEV4Y2VlZGVkOiBvblJhdGVMaW1pdEV4Y2VlZGVkU3R1Yixcblx0XHRcdG9uUmF0ZUxpbWl0UGF1c2U6IG9uUmF0ZUxpbWl0UGF1c2VTdHViLFxuXHRcdFx0b25SYXRlTGltaXRSZXN1bWU6IG9uUmF0ZUxpbWl0UmVzdW1lU3R1Yixcblx0XHR9IGFzIGFueSk7XG5cblx0XHRleHBlY3QuYXNzZXJ0aW9ucygzKTtcblxuXHRcdHJldHVybiBQcm9taXNlLmFsbChbYXBpLmdldCgnL2xpbWl0JyksIGFwaS5nZXQoJy9saW1pdCcpLCBhcGkuZ2V0KCcvbGltaXQnKV0pLnRoZW4oKCkgPT4ge1xuXHRcdFx0ZXhwZWN0KG9uUmF0ZUxpbWl0RXhjZWVkZWRTdHViKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuXHRcdFx0ZXhwZWN0KG9uUmF0ZUxpbWl0UGF1c2VTdHViKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG5cdFx0XHRleHBlY3Qob25SYXRlTGltaXRSZXN1bWVTdHViKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG5cdFx0XHRyZXR1cm47XG5cdFx0fSk7XG5cdH0pO1xufSk7XG4iXX0=